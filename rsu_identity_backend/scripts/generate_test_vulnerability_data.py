#!/usr/bin/env python
"""
ğŸ‡¬ğŸ‡¦ RSU Gabon - GÃ©nÃ©ration donnÃ©es test VulnÃ©rabilitÃ©
CrÃ©e des VulnerabilityAssessment rÃ©alistes pour le dashboard
"""

import os
import sys
import django
import random
from decimal import Decimal

# Configuration Django
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'rsu_identity.settings.development')
django.setup()

from apps.identity_app.models import PersonIdentity
from apps.services_app.models import VulnerabilityAssessment
from apps.programs_app.models import SocialProgram
from django.db import models
from django.utils import timezone


def generate_vulnerability_assessments():
    """GÃ©nÃ¨re des Ã©valuations de vulnÃ©rabilitÃ© pour toutes les personnes"""
    
    print("=" * 80)
    print("ğŸ‡¬ğŸ‡¦ GÃ‰NÃ‰RATION DONNÃ‰ES TEST - VULNERABILITY ASSESSMENTS")
    print("=" * 80)
    
    # RÃ©cupÃ©rer toutes les personnes
    persons = PersonIdentity.objects.all()
    total_persons = persons.count()
    
    if total_persons == 0:
        print("âŒ Aucune personne trouvÃ©e dans la base de donnÃ©es!")
        print("   ExÃ©cutez d'abord le script de gÃ©nÃ©ration de PersonIdentity.")
        return
    
    print(f"\nğŸ“Š {total_persons} personnes trouvÃ©es")
    
    # RÃ©cupÃ©rer un programme par dÃ©faut (requis par le modÃ¨le)
    default_program = SocialProgram.objects.first()
    if not default_program:
        print("âŒ Aucun programme trouvÃ©! CrÃ©ation d'un programme par dÃ©faut...")
        default_program = SocialProgram.objects.create(
            code='DEFAULT',
            name='Programme par dÃ©faut',
            status='ACTIVE',
            total_budget=1000000,
            budget_spent=0
        )
        print(f"âœ… Programme crÃ©Ã©: {default_program.name}")
    
    print(f"ğŸ“¦ Programme utilisÃ©: {default_program.name}")
    
    # Supprimer anciennes Ã©valuations
    old_count = VulnerabilityAssessment.objects.count()
    if old_count > 0:
        print(f"\nğŸ—‘ï¸  Suppression de {old_count} anciennes Ã©valuations...")
        VulnerabilityAssessment.objects.all().delete()
    
    print("\nğŸ”„ GÃ©nÃ©ration des Ã©valuations...")
    
    created_count = 0
    
    # Distribution rÃ©aliste des niveaux de risque
    risk_distribution = {
        'CRITICAL': 0.15,  # 15% critique
        'HIGH': 0.25,      # 25% Ã©levÃ©
        'MODERATE': 0.40,  # 40% modÃ©rÃ©
        'LOW': 0.20,       # 20% faible
    }
    
    for person in persons:
        # DÃ©terminer niveau de risque selon distribution
        rand = random.random()
        cumulative = 0
        risk_level = 'LOW'
        
        for level, probability in risk_distribution.items():
            cumulative += probability
            if rand <= cumulative:
                risk_level = level
                break
        
        # GÃ©nÃ©rer scores basÃ©s sur le niveau de risque
        if risk_level == 'CRITICAL':
            base_score = random.uniform(75, 95)
        elif risk_level == 'HIGH':
            base_score = random.uniform(50, 74)
        elif risk_level == 'MODERATE':
            base_score = random.uniform(25, 49)
        else:  # LOW
            base_score = random.uniform(5, 24)
        
        # Scores par dimension (avec variation)
        household_score = max(0, min(100, base_score + random.uniform(-10, 10)))
        economic_score = max(0, min(100, base_score + random.uniform(-15, 15)))
        social_score = max(0, min(100, base_score + random.uniform(-10, 10)))
        
        # Facteurs de vulnÃ©rabilitÃ© (exemples rÃ©alistes)
        vulnerability_factors = []
        if base_score > 50:
            vulnerability_factors.extend([
                "Revenu insuffisant",
                "AccÃ¨s limitÃ© aux services de santÃ©",
                "Logement prÃ©caire"
            ])
        if base_score > 70:
            vulnerability_factors.extend([
                "Malnutrition",
                "Absence de rÃ©seau social",
                "Zone rurale isolÃ©e"
            ])
        
        risk_factors = []
        if economic_score > 60:
            risk_factors.append("ChÃ´mage")
        if household_score > 60:
            risk_factors.append("Charge familiale Ã©levÃ©e")
        
        protective_factors = []
        if base_score < 50:
            protective_factors.extend([
                "Emploi stable",
                "RÃ©seau familial solide",
                "AccÃ¨s aux services de base"
            ])
        
        # Recommandations
        recommendations = []
        if risk_level in ['CRITICAL', 'HIGH']:
            recommendations.extend([
                "PrioritÃ© transferts monÃ©taires d'urgence",
                "Suivi mÃ©dical rapprochÃ©",
                "Programme nutrition"
            ])
        elif risk_level == 'MODERATE':
            recommendations.extend([
                "Ã‰valuation approfondie nÃ©cessaire",
                "Formation professionnelle",
                "Appui Ã©conomique"
            ])
        
        priority_interventions = []
        if risk_level == 'CRITICAL':
            priority_interventions.extend([
                "Intervention d'urgence < 48h",
                "Assistance alimentaire immÃ©diate"
            ])
        
        # CrÃ©er l'Ã©valuation (SANS assessed_by)
        try:
            VulnerabilityAssessment.objects.create(
                program=default_program,  # âœ… REQUIS
                person=person,
                vulnerability_score=Decimal(str(round(base_score, 2))),
                risk_level=risk_level,
                household_composition_score=Decimal(str(round(household_score, 2))),
                economic_vulnerability_score=Decimal(str(round(economic_score, 2))),
                social_vulnerability_score=Decimal(str(round(social_score, 2))),
                vulnerability_factors=vulnerability_factors,
                risk_factors=risk_factors,
                protective_factors=protective_factors,
                recommendations=recommendations,
                priority_interventions=priority_interventions,
                # assessment_date auto_now_add
                is_active=True
            )
            created_count += 1
            
            if created_count % 100 == 0:
                print(f"   âœ… {created_count}/{total_persons} Ã©valuations crÃ©Ã©es...")
        
        except Exception as e:
            print(f"   âŒ Erreur pour personne {person.rsu_id}: {e}")
            continue
    
    print(f"\nâœ… {created_count} Ã©valuations crÃ©Ã©es avec succÃ¨s!")
    
    # Statistiques finales
    print("\nğŸ“Š STATISTIQUES GÃ‰NÃ‰RÃ‰ES:")
    for level in ['CRITICAL', 'HIGH', 'MODERATE', 'LOW']:
        count = VulnerabilityAssessment.objects.filter(risk_level=level).count()
        percentage = (count / created_count * 100) if created_count > 0 else 0
        print(f"   {level:10s}: {count:5d} ({percentage:5.1f}%)")
    
    avg_score = VulnerabilityAssessment.objects.aggregate(
        avg=models.Avg('vulnerability_score')
    )['avg']
    
    if avg_score:
        print(f"\nğŸ“ˆ Score moyen global: {avg_score:.2f}")
    else:
        print(f"\nâš ï¸  Aucun score calculÃ© (0 Ã©valuations)")
    
    print("\n" + "=" * 80)
    print("âœ… GÃ‰NÃ‰RATION TERMINÃ‰E - Dashboard prÃªt Ã  afficher les donnÃ©es!")
    print("=" * 80)


if __name__ == '__main__':
    generate_vulnerability_assessments()