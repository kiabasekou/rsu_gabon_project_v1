{"version":3,"file":"integration.js","sourceRoot":"","sources":["../../../src/js/profiling/integration.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Hub } from '@sentry/core';\nimport { getActiveTransaction } from '@sentry/core';\nimport type { Envelope, Event, EventProcessor, Integration, Profile, Transaction } from '@sentry/types';\nimport { logger, uuid4 } from '@sentry/utils';\n\nimport { isHermesEnabled } from '../utils/environment';\nimport { PROFILE_QUEUE } from './cache';\nimport { startProfiling, stopProfiling } from './hermes';\nimport { addProfilesToEnvelope, createProfilingEvent, findProfiledTransactionsFromEnvelope } from './utils';\n\nexport const MAX_PROFILE_DURATION_MS = 30 * 1e3;\n\n/**\n * Profiling integration creates a profile for each transaction and adds it to the event envelope.\n *\n * @experimental\n */\nexport class HermesProfiling implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'HermesProfiling';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = HermesProfiling.id;\n\n  private _getCurrentHub?: () => Hub;\n\n  private _currentProfile:\n    | {\n        profile_id: string;\n        startTimestampNs: number;\n      }\n    | undefined;\n\n  private _currentProfileTimeout: number | undefined;\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(_: (e: EventProcessor) => void, getCurrentHub: () => Hub): void {\n    if (!isHermesEnabled()) {\n      logger.log('[Profiling] Hermes is not enabled, not adding profiling integration.');\n      return;\n    }\n\n    this._getCurrentHub = getCurrentHub;\n    const client = getCurrentHub().getClient();\n\n    if (!client || typeof client.on !== 'function') {\n      return;\n    }\n\n    this._startCurrentProfileForActiveTransaction();\n    client.on('startTransaction', this._startCurrentProfile);\n\n    client.on('finishTransaction', this._finishCurrentProfile);\n\n    client.on('beforeEnvelope', (envelope: Envelope) => {\n      if (!PROFILE_QUEUE.size()) {\n        return;\n      }\n\n      const profiledTransactions = findProfiledTransactionsFromEnvelope(envelope);\n      if (!profiledTransactions.length) {\n        logger.log('[Profiling] no profiled transactions found in envelope');\n        return;\n      }\n\n      const profilesToAddToEnvelope: Profile[] = [];\n      for (const profiledTransaction of profiledTransactions) {\n        const profile = this._createProfileEventFor(profiledTransaction);\n        if (profile) {\n          profilesToAddToEnvelope.push(profile);\n        }\n      }\n      addProfilesToEnvelope(envelope, profilesToAddToEnvelope);\n    });\n  }\n\n  private _startCurrentProfileForActiveTransaction = (): void => {\n    if (this._currentProfile) {\n      return;\n    }\n    const transaction = this._getCurrentHub && getActiveTransaction(this._getCurrentHub());\n    transaction && this._startCurrentProfile(transaction);\n  };\n\n  private _startCurrentProfile = (transaction: Transaction): void => {\n    this._finishCurrentProfile();\n\n    const shouldStartProfiling = this._shouldStartProfiling(transaction);\n    if (!shouldStartProfiling) {\n      return;\n    }\n\n    this._currentProfileTimeout = setTimeout(this._finishCurrentProfile, MAX_PROFILE_DURATION_MS);\n    this._startNewProfile(transaction);\n  };\n\n  private _shouldStartProfiling = (transaction: Transaction): boolean => {\n    if (!transaction.sampled) {\n      logger.log('[Profiling] Transaction is not sampled, skipping profiling');\n      return false;\n    }\n\n    const client = this._getCurrentHub && this._getCurrentHub().getClient();\n    const options = client && client.getOptions();\n\n    const profilesSampleRate =\n      options && options._experiments && typeof options._experiments.profilesSampleRate === 'number'\n        ? options._experiments.profilesSampleRate\n        : undefined;\n    if (profilesSampleRate === undefined) {\n      logger.log('[Profiling] Profiling disabled, enable it by setting `profilesSampleRate` option to SDK init call.');\n      return false;\n    }\n\n    // Check if we should sample this profile\n    if (Math.random() > profilesSampleRate) {\n      logger.log('[Profiling] Skip profiling transaction due to sampling.');\n      return false;\n    }\n\n    return true;\n  };\n\n  /**\n   * Starts a new profile and links it to the transaction.\n   */\n  private _startNewProfile = (transaction: Transaction): void => {\n    const profileStartTimestampNs = startProfiling();\n    if (!profileStartTimestampNs) {\n      return;\n    }\n\n    this._currentProfile = {\n      profile_id: uuid4(),\n      startTimestampNs: profileStartTimestampNs,\n    };\n    transaction.setContext('profile', { profile_id: this._currentProfile.profile_id });\n    // @ts-expect-error profile_id is not part of the metadata type\n    transaction.setMetadata({ profile_id: this._currentProfile.profile_id });\n    logger.log('[Profiling] started profiling: ', this._currentProfile.profile_id);\n  };\n\n  /**\n   * Stops profiling and adds the profile to the queue to be processed on beforeEnvelope.\n   */\n  private _finishCurrentProfile = (): void => {\n    this._clearCurrentProfileTimeout();\n    if (this._currentProfile === undefined) {\n      return;\n    }\n\n    const profile = stopProfiling();\n    if (!profile) {\n      logger.warn('[Profiling] Stop failed. Cleaning up...');\n      this._currentProfile = undefined;\n      return;\n    }\n\n    profile.profile_id = this._currentProfile.profile_id;\n    PROFILE_QUEUE.add(profile.profile_id, profile);\n    logger.log('[Profiling] finished profiling: ', this._currentProfile.profile_id);\n    this._currentProfile = undefined;\n  };\n\n  private _createProfileEventFor = (profiledTransaction: Event): Profile | null => {\n    const profile_id = profiledTransaction?.contexts?.['profile']?.['profile_id'];\n\n    if (typeof profile_id !== 'string') {\n      logger.log('[Profiling] cannot find profile for a transaction without a profile context');\n      return null;\n    }\n\n    // Remove the profile from the transaction context before sending, relay will take care of the rest.\n    if (profiledTransaction?.contexts?.['.profile']) {\n      delete profiledTransaction.contexts.profile;\n    }\n\n    const cpuProfile = PROFILE_QUEUE.get(profile_id);\n    PROFILE_QUEUE.delete(profile_id);\n\n    if (!cpuProfile) {\n      logger.log(`[Profiling] cannot find profile ${profile_id} for transaction ${profiledTransaction.event_id}`);\n      return null;\n    }\n\n    const profile = createProfilingEvent(cpuProfile, profiledTransaction);\n    logger.log(`[Profiling] Created profile ${profile_id} for transaction ${profiledTransaction.event_id}`);\n    return profile;\n  };\n\n  private _clearCurrentProfileTimeout = (): void => {\n    this._currentProfileTimeout !== undefined && clearTimeout(this._currentProfileTimeout);\n    this._currentProfileTimeout = undefined;\n  };\n}\n"]}